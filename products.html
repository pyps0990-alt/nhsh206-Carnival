<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="飲ㄐㄩ啦.ico" type="image/x-icon">
  <title>商品列表</title>
  <style>
    /* 手機友善版 checkout summary */
#checkout-summary > div {
  display: flex;
  flex-wrap: wrap; /* 可以換行 */
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding: 6px 4px;
  border-bottom: 1px solid #eee;
}

#checkout-summary span,
#checkout-summary .qty-control {
  flex: 1 1 auto; /* 可縮放 */
  margin: 2px 0;
}

.qty-control button {
  width: 28px;
  height: 28px;
  font-size: 16px;
}

.qty-control .qty {
  min-width: 20px;
  font-size: 14px;
  padding: 2px 6px;
}

#total-amount {
  text-align: right;
  font-size: 16px;
}

    /* ======= 數量控制樣式 ======= */
    .qty-control {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      margin-top: 6px;
    }
    .qty-control button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--panel);
      color: var(--text);
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      transition: filter .2s;
    }
    .qty-control button:hover { filter: brightness(1.2); }
    .qty-control .qty {
      min-width: 24px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--text);
      background: var(--bg);
      border-radius: 6px;
      padding: 4px 8px;
    }

    /* ======= 加入購物車提示 ======= */
    .added-tip { 
      position: fixed; top: 20%; left: 50%; transform: translateX(-50%) scale(0);
      background: var(--primary); color: #f5f5ef; padding: 8px 14px; border-radius: 12px; font-weight: 700;
      opacity: 0; pointer-events: none; transition: opacity .4s ease, transform .4s ease; z-index: 9999; 
    }
    .added-tip.show { 
      opacity: 1; transform: translateX(-50%) scale(1); 
    }

    /* ======= 左上角浮動訂單動畫 ======= */
    #active-orders-banner {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      background: #ffeaa7;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 999;
    }

    /* ======= 商品格子布局與淡入動畫 ======= */
    #menu-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width: 600px) { #menu-list { grid-template-columns: 1fr 1fr; } }
    @media(min-width: 992px) { #menu-list { grid-template-columns: 1fr 1fr 1fr 1fr; } }

    .product-card {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.5s forwards;
    }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- 浮動訂單動畫 -->
  <div id="active-orders-banner">
    <strong>正在進行中的訂單：</strong>
    <span id="active-orders-info"></span>
  </div>

  <!-- 加入購物車提示 -->
  <div id="added-tip" style="
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#7a9d54; color:white; padding:10px 16px;
    border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2);
    opacity:0; pointer-events:none; transition:0.4s;
    z-index:9999;
  ">已加入購物車 ✅</div>

  <header class="site-header">
    <div class="container header-inner">
      <div class="brand-wrap">
        <h1 class="brand">飲ㄐㄩ啦</h1>
      </div>
      <nav class="nav">
        <a href="index.html">返回首頁</a>
        <a href="cart.html" class="cart-link" id="cart-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <span id="cart-badge" class="cart-badge">0</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container" id="menu-list">
        <p>讀取中...</p>
      </div>
    </section>

    <section id="product-detail"></section>
  </main>
  <div id="detail-overlay"></div>
</body>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// ------------------ 顧客 ID ------------------
let customerId = localStorage.getItem('customerId');
if (!customerId) {
  customerId = 'c_' + Math.random().toString(36).slice(2,9);
  localStorage.setItem('customerId', customerId);
}

// ------------------ Firebase 初始化 ------------------
const firebaseConfig = {
  apiKey: "AIzaSyAk6JPL61gRlRtLP7926iAfbSr05O0AM9s",
  authDomain: "nhshfestival.firebaseapp.com",
  databaseURL: "https://nhshfestival-default-rtdb.firebaseio.com",
  projectId: "nhshfestival",
  storageBucket: "nhshfestival.firebasestorage.app",
  messagingSenderId: "337149505249",
  appId: "1:337149505249:web:4e81a826911c078fd811a0"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 新增函式：顯示加入購物車提示
function showAddedTip(){
  const tip = document.getElementById('added-tip');
  if(!tip) return;
  tip.style.opacity = '1';
  setTimeout(() => { tip.style.opacity = '0'; }, 1200);
}

// ------------------ 購物車 ------------------
function readOrders() { return JSON.parse(localStorage.getItem('class206_orders_v2') || '[]'); }
function writeOrders(list){ 
  localStorage.setItem('class206_orders_v2', JSON.stringify(list)); 
  syncCartBadge(); 
}
function syncCartBadge(){
  const badge = document.getElementById('cart-badge');
  if (!badge) return;
  const orders = readOrders();
  let count = 0;
  orders.forEach(o => o.items.forEach(i => count += i.qty));
  badge.textContent = count;
}

// ------------------ 商品列表 ------------------
let products = [];

function renderMenu(){
  const wrap = document.getElementById('menu-list');
  wrap.innerHTML = '';
  products.forEach((item, index) => {
    const card = document.createElement('article');
    card.className = 'card product-card';
    card.style.animationDelay = `${index*0.05}s`;
    card.innerHTML = `
      <div style="position:relative;border-radius:10px;overflow:hidden;margin:-6px -6px 10px;border:1px solid rgba(255,255,255,.06)">
        <img src="${item.img}" alt="${item.name}" style="width:100%;height:140px;object-fit:cover;">
        ${item.hot ? '<span class="hot-badge">熱銷</span>' : ''}
        <span class="price-badge">$${item.price}</span>
      </div>
      <h4>${item.name}</h4>
      <p class="muted">${item.desc}</p>
      <p class="muted">庫存：${item.stock}</p>
      <div class="qty-control" data-id="${item.id}">
        <button class="btn-decrease">-</button>
        <span class="qty">1</span>
        <button class="btn-increase">+</button>
      </div>
      <button class="btn primary" data-add="${item.id}">加入</button>
    `;
    wrap.appendChild(card);
  });

  wrap.addEventListener('click', e => {
    const control = e.target.closest('.qty-control');
    if (control){
      const id = control.dataset.id;
      const span = control.querySelector('.qty');
      let qty = Number(span.textContent);
      const item = products.find(p => p.id === id);
      if (e.target.classList.contains('btn-increase')) qty = Math.min(qty+1, item.stock);
      if (e.target.classList.contains('btn-decrease')) qty = Math.max(qty-1, 1);
      span.textContent = qty;
    }

    const btnAdd = e.target.closest('button[data-add]');
    if (btnAdd){
      const id = btnAdd.dataset.add;
      const qty = Number(btnAdd.closest('.card').querySelector('.qty').textContent);
      addToCart(id, qty);
    }

    const btnDetail = e.target.closest('button[data-detail]');
    if (btnDetail){
      const id = btnDetail.dataset.detail;
      showProductDetail(id);
    }
  });
}

// ------------------ 加入購物車 ------------------
function addToCart(itemId, qty=1){
  const item = products.find(p => p.id===itemId);
  if (!item) return;
  if (item.stock < qty){ alert(`庫存不足，目前剩 ${item.stock} 件`); return; }

  const orders = readOrders();
  const existingIndex = orders.findIndex(o => o.items.some(i => i.id===itemId));
  if (existingIndex >=0){
    const currentQty = orders[existingIndex].items[0].qty;
    if (currentQty+qty>item.stock){
      alert(`庫存不足，最多還能購買 ${item.stock-currentQty} 件`);
      return;
    }
    orders[existingIndex].items[0].qty += qty;
  } else {
    orders.push({
      id: 'o_'+Math.random().toString(36).slice(2,9),
      createdAt: Date.now(),
      items: [{id:itemId, qty}],
      status: '準備中'
    });
  }
  writeOrders(orders);
  showAddedTip();
}

// ------------------ 商品詳情 ------------------
function showProductDetail(itemId){
  const item = products.find(p => p.id === itemId);
  if(!item) return;

  const detail = document.getElementById('product-detail');

  detail.innerHTML = `
    <img src="${item.img}" alt="${item.name}">
    <h4>${item.name}</h4>
    <p>${item.desc}</p>
    <p>價格：$${item.price}</p>
    <p>庫存：${item.stock}</p>
    <button class="close-detail">關閉</button>
  `;
  
  detail.classList.add('show');

  // 關閉按鈕 & 點擊背景
  const closeBtn = detail.querySelector('.close-detail');
  closeBtn.onclick = () => {
    detail.classList.remove('show');
  };
  overlay.onclick = () => {
    detail.classList.remove('show');
  };
}


// ------------------ 讀取 Firebase ------------------
function loadProductsRealtime(){
  const productsRef = ref(db, 'products');
  onValue(productsRef, snapshot=>{
    const data = snapshot.val()||{};
    products = Object.entries(data).map(([id,d])=>({id,...d}));
    renderMenu();
    syncCartBadge();
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadProductsRealtime();
  syncCartBadge();
});
</script>
</body>
</html>
